name: Update gold/silver (MCX Metals.dev â†’ rates.json)

on:
  schedule:
    - cron: "30 3 * * 1-5"
    - cron: "30 12 * * 1-5"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-and-build:
    runs-on: ubuntu-latest
    env:
      TZ: "Asia/Kolkata"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq & bc
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Fetch via Metals.dev (MCX authority) and generate rates.json
        env:
          METALS_API_KEY: ${{ secrets.METALS_API_KEY }}
        run: |
          set -euo pipefail
          [ -z "${METALS_API_KEY:-}" ] && { echo "âŒ No METALS_API_KEY found"; exit 1; }

          echo "ðŸ”„ Fetching MCX INR/g rates from Metals.dev ..."
          RESP=$(curl -sSf -G "https://api.metals.dev/v1/metal/authority" \
            -H "Accept: application/json" \
            --data-urlencode "api_key=${METALS_API_KEY}" \
            --data-urlencode "authority=mcx" \
            --data-urlencode "currency=INR" \
            --data-urlencode "unit=g")

          echo "$RESP" | jq '.' > /tmp/metals.json

          MCX_GOLD=$(jq -r '.rates.mcx_gold' /tmp/metals.json)
          MCX_SILVER=$(jq -r '.rates.mcx_silver' /tmp/metals.json)
          TS=$(jq -r '.timestamp' /tmp/metals.json)
          SRC="Metals.dev (MCX authority â†’ INR/g)"

          [ -z "$MCX_GOLD" ] && MCX_GOLD=0
          [ -z "$MCX_SILVER" ] && MCX_SILVER=0

          GOLD_SCALE=10
          SILVER_SCALE=1000

          mkdir -p data
          rm -f tmp_rate_*.json || true

          compute_line() {
            local key="$1"; local label="$2"; local base="$3"; local purity="$4"
            local scale="$5"; local margin="$6"; local bspread="$7"; local sspread="$8"
            local rawBase=$(awk "BEGIN{printf \"%.6f\", ($base * ($purity/100) * $scale)}")
            local mid=$(awk "BEGIN{printf \"%.6f\", ($rawBase * (1 + $margin))}")
            local buy=$(awk "BEGIN{printf \"%.0f\", ($mid * (1 - $bspread))}")
            local sell=$(awk "BEGIN{printf \"%.0f\", ($mid * (1 + $sspread))}")
            jq -n \
              --arg key "$key" \
              --arg label "$label" \
              --arg unit "${scale} g" \
              --argjson buy "$buy" \
              --argjson sell "$sell" \
              '{key:$key,label:$label,unit:$unit,buy:$buy,sell:$sell}'
          }

          # --- Base (from MCX)
          GOLD_BASE=$MCX_GOLD
          SILVER_BASE=$MCX_SILVER

          # --- Margins / spreads ---
          GOLD_99_5_CASH_MARGIN=0.06
          GOLD_99_5_RTGS_MARGIN=0.04
          SILVER_REFINERY_MARGIN=0.05
          SILVER_999_RTGS_MARGIN=0.035
          BASIC_MARGIN=0.00

          # --- Compute all items ---
          compute_line "gold_max" "GOLD MAX (MCX GOLD)" "$GOLD_BASE" 99.5 "$GOLD_SCALE" 0 0 0 > tmp_rate_gold_max.json
          compute_line "silver_max" "SILVER MAX (MCX SILVER)" "$SILVER_BASE" 99.9 "$SILVER_SCALE" 0 0 0 > tmp_rate_silver_max.json

          compute_line "gold_99_50_cash" "GOLD 99.50 CASH BHAV" "$GOLD_BASE" 99.5 "$GOLD_SCALE" $GOLD_99_5_CASH_MARGIN 0.0025 0.0025 > tmp_rate_gold_9950_cash.json
          compute_line "gold_99_50_rtgs" "GOLD 99.50 RTGS BHAV 10-20-50 GM" "$GOLD_BASE" 99.5 "$GOLD_SCALE" $GOLD_99_5_RTGS_MARGIN 0.003 0.003 > tmp_rate_gold_9950_rtgs.json
          compute_line "silver_refinery" "SILVER REFINERY 99 PLUS CASH BHAV" "$SILVER_BASE" 99.0 "$SILVER_SCALE" $SILVER_REFINERY_MARGIN 0.003 0.003 > tmp_rate_silver_refinery.json
          compute_line "silver_999_cash" "SILVER 999 SILCUT CASH BHAV" "$SILVER_BASE" 99.9 "$SILVER_SCALE" $SILVER_REFINERY_MARGIN 0.003 0.003 > tmp_rate_silver_999_cash.json
          compute_line "silver_999_rtgs" "SILVER SILCUT 999 RTGS BHAV 1-2-3-5 KG" "$SILVER_BASE" 99.9 "$SILVER_SCALE" $SILVER_999_RTGS_MARGIN 0.0025 0.0025 > tmp_rate_silver_999_rtgs.json

          # Basic gold prices
          G22=$(awk "BEGIN{printf \"%.8f\", $GOLD_BASE * 22/24}")
          G20=$(awk "BEGIN{printf \"%.8f\", $GOLD_BASE * 20/24}")
          G18=$(awk "BEGIN{printf \"%.8f\", $GOLD_BASE * 18/24}")
          G14=$(awk "BEGIN{printf \"%.8f\", $GOLD_BASE * 14/24}")
          G10=$(awk "BEGIN{printf \"%.8f\", $GOLD_BASE * 10/24}")

          compute_line "gold_22k_basic" "22 K GOLD BASIC PRICE (GST & MAKING EXTRA)" "$G22" 100 "$GOLD_SCALE" $BASIC_MARGIN 0 0 > tmp_rate_gold_22.json
          compute_line "gold_20k_basic" "20 K GOLD BASIC PRICE (GST & MAKING EXTRA)" "$G20" 100 "$GOLD_SCALE" $BASIC_MARGIN 0 0 > tmp_rate_gold_20.json
          compute_line "gold_18k_basic" "18 K GOLD BASIC PRICE (GST & MAKING EXTRA)" "$G18" 100 "$GOLD_SCALE" $BASIC_MARGIN 0 0 > tmp_rate_gold_18.json
          compute_line "gold_14k_basic" "14 K GOLD BASIC PRICE (GST & MAKING EXTRA)" "$G14" 100 "$GOLD_SCALE" $BASIC_MARGIN 0 0 > tmp_rate_gold_14.json
          compute_line "gold_10k_basic" "10 K GOLD BASIC PRICE (GST & MAKING EXTRA)" "$G10" 100 "$GOLD_SCALE" $BASIC_MARGIN 0 0 > tmp_rate_gold_10.json

          # Combine all
          jq -s '.' tmp_rate_*.json > data/tmp_rates.json
          UPDATED=$(TZ=Asia/Kolkata date "+%Y-%m-%d %H:%M IST")

          jq --arg updated "$UPDATED" \
             --arg source "$SRC" \
             --arg ts "$TS" \
             '. as $arr | {updated:$updated, timestamp:$ts, source:$source, items:$arr}' \
             data/tmp_rates.json > data/rates.json

          echo "âœ… Final rates.json generated:"
          jq '.items | length' data/rates.json

      - name: Commit & push data/rates.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/rates.json
          git commit -m "Auto-update Metals.dev MCX rates.json" || echo "No changes"
          git push
