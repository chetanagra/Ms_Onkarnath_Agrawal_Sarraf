name: Update gold/silver rates (GoldAPI â†” MetalpriceAPI)

on:
  schedule:
    - cron: "0 */4 * * *"   # every 4 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      OUNCE_TO_GRAM: "31.1034768"
      TZ: "Asia/Kolkata"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq + python3
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3

      - name: Select provider (alternate each run)
        id: select
        run: |
          set -euo pipefail
          rn=${GITHUB_RUN_NUMBER}
          if [ $((rn % 2)) -eq 0 ]; then
            echo "provider=goldapi" >> "$GITHUB_OUTPUT"
          else
            echo "provider=metalprice" >> "$GITHUB_OUTPUT"
          fi

      # -------- GoldAPI --------
      - name: Fetch via GoldAPI
        id: goldapi
        if: steps.select.outputs.provider == 'goldapi'
        env:
          GOLDAPI_KEY: ${{ secrets.GOLDAPI_KEY }}
        run: |
          set -euo pipefail
          [ -z "${GOLDAPI_KEY:-}" ] && { echo "No GOLDAPI_KEY"; exit 1; }
          XAU_JSON=$(curl -fSs -H "x-access-token: $GOLDAPI_KEY" https://www.goldapi.io/api/XAU/INR)
          XAG_JSON=$(curl -fSs -H "x-access-token: $GOLDAPI_KEY" https://www.goldapi.io/api/XAG/INR)
          POZ_G=$(echo "$XAU_JSON" | jq -r '.price // empty')  # INR per troy ounce
          POZ_S=$(echo "$XAG_JSON" | jq -r '.price // empty')  # INR per troy ounce
          [ -z "$POZ_G" ] && { echo "GoldAPI missing gold price"; exit 1; }
          export POZ_G POZ_S OUNCE_TO_GRAM
          GOLD24=$(python3 -c 'import os; print(int(round(float(os.environ["POZ_G"])/float(os.environ["OUNCE_TO_GRAM"]))))')
          SILVER=$(python3 -c 'import os; print(int(round(float(os.environ.get("POZ_S","0"))/float(os.environ["OUNCE_TO_GRAM"]))))')
          echo "Computed (INR/oz): gold=$POZ_G silver=${POZ_S:-N/A}"
          echo "gold24=$GOLD24" >> "$GITHUB_OUTPUT"
          echo "silver=$SILVER" >> "$GITHUB_OUTPUT"
          echo "source=GoldAPI" >> "$GITHUB_OUTPUT"

      # -------- MetalpriceAPI --------
      - name: Fetch via MetalpriceAPI
        id: metalprice
        if: steps.select.outputs.provider == 'metalprice'
        env:
          METALPRICE_KEY: ${{ secrets.METALPRICE_KEY }}
        run: |
          set -euo pipefail
          [ -z "${METALPRICE_KEY:-}" ] && { echo "No METALPRICE_KEY"; exit 1; }
          RESP=$(curl -fSs "https://api.metalpriceapi.com/v1/latest?api_key=$METALPRICE_KEY&base=INR&currencies=XAU,XAG")
          R_XAU=$(echo "$RESP" | jq -r '.rates.XAU // empty')  # XAU per 1 INR
          R_XAG=$(echo "$RESP" | jq -r '.rates.XAG // empty')  # XAG per 1 INR
          [ -z "$R_XAU" ] && { echo "MetalpriceAPI missing XAU"; exit 1; }

          # Invert: want INR per troy ounce
          inv() { awk 'function inv(x){ if (x==0){exit 1} else {printf "%.8f", 1/x} } {inv($0)}'; }
          POZ_G=$(printf "%s" "$R_XAU" | inv) || { echo "Invalid XAU rate (zero)"; exit 1; }
          if [ -n "$R_XAG" ]; then POZ_S=$(printf "%s" "$R_XAG" | inv) || POZ_S=""; else POZ_S=""; fi

          export POZ_G POZ_S OUNCE_TO_GRAM
          GOLD24=$(python3 -c 'import os; print(int(round(float(os.environ["POZ_G"])/float(os.environ["OUNCE_TO_GRAM"]))))')
          SILVER=$(python3 -c 'import os; print(int(round(float(os.environ.get("POZ_S","0"))/float(os.environ["OUNCE_TO_GRAM"]))))')
          echo "Computed (INR/oz): gold=$POZ_G silver=${POZ_S:-N/A}"
          echo "gold24=$GOLD24" >> "$GITHUB_OUTPUT"
          echo "silver=$SILVER" >> "$GITHUB_OUTPUT"
          echo "source=MetalpriceAPI" >> "$GITHUB_OUTPUT"

      # -------- Fallback to the other provider if primary failed --------
      - name: Fallback (try alternate provider)
        id: fallback
        if: failure()
        env:
          GOLDAPI_KEY: ${{ secrets.GOLDAPI_KEY }}
          METALPRICE_KEY: ${{ secrets.METALPRICE_KEY }}
        run: |
          set -euo pipefail
          sel='${{ steps.select.outputs.provider }}'
          if [ "$sel" = "goldapi" ]; then
            [ -z "${METALPRICE_KEY:-}" ] && { echo "No METALPRICE_KEY for fallback"; exit 1; }
            RESP=$(curl -fSs "https://api.metalpriceapi.com/v1/latest?api_key=$METALPRICE_KEY&base=INR&currencies=XAU,XAG")
            R_XAU=$(echo "$RESP" | jq -r '.rates.XAU // empty')
            R_XAG=$(echo "$RESP" | jq -r '.rates.XAG // empty')
            [ -z "$R_XAU" ] && { echo "Fallback MetalpriceAPI missing XAU"; exit 1; }
            inv() { awk 'function inv(x){ if (x==0){exit 1} else {printf "%.8f", 1/x} } {inv($0)}'; }
            POZ_G=$(printf "%s" "$R_XAU" | inv) || { echo "Invalid XAU rate (zero)"; exit 1; }
            if [ -n "$R_XAG" ]; then POZ_S=$(printf "%s" "$R_XAG" | inv) || POZ_S=""; else POZ_S=""; fi
            SRC="MetalpriceAPI"
          else
            [ -z "${GOLDAPI_KEY:-}" ] && { echo "No GOLDAPI_KEY for fallback"; exit 1; }
            XAU_JSON=$(curl -fSs -H "x-access-token: $GOLDAPI_KEY" https://www.goldapi.io/api/XAU/INR)
            XAG_JSON=$(curl -fSs -H "x-access-token: $GOLDAPI_KEY" https://www.goldapi.io/api/XAG/INR)
            POZ_G=$(echo "$XAU_JSON" | jq -r '.price // empty')
            POZ_S=$(echo "$XAG_JSON" | jq -r '.price // empty')
            SRC="GoldAPI"
          fi
          [ -z "$POZ_G" ] && { echo "Fallback provider missing price"; exit 1; }
          export POZ_G POZ_S OUNCE_TO_GRAM
          GOLD24=$(python3 -c 'import os; print(int(round(float(os.environ["POZ_G"])/float(os.environ["OUNCE_TO_GRAM"]))))')
          SILVER=$(python3 -c 'import os; print(int(round(float(os.environ.get("POZ_S","0"))/float(os.environ["OUNCE_TO_GRAM"]))))')
          echo "Computed (INR/oz): gold=$POZ_G silver=${POZ_S:-N/A}"
          echo "gold24=$GOLD24" >> "$GITHUB_OUTPUT"
          echo "silver=$SILVER" >> "$GITHUB_OUTPUT"
          echo "source=$SRC" >> "$GITHUB_OUTPUT"

      # -------- Consolidate whichever step succeeded --------
      - name: Consolidate outputs
        id: out
        if: always()
        run: |
          set -euo pipefail
          if [ "${{ steps.goldapi.outcome }}" = "success" ]; then
            echo "G24=${{ steps.goldapi.outputs.gold24 }}" >> "$GITHUB_OUTPUT"
            echo "SIL=${{ steps.goldapi.outputs.silver }}" >> "$GITHUB_OUTPUT"
            echo "SRC=${{ steps.goldapi.outputs.source }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ steps.metalprice.outcome }}" = "success" ]; then
            echo "G24=${{ steps.metalprice.outputs.gold24 }}" >> "$GITHUB_OUTPUT"
            echo "SIL=${{ steps.metalprice.outputs.silver }}" >> "$GITHUB_OUTPUT"
            echo "SRC=${{ steps.metalprice.outputs.source }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ steps.fallback.outcome }}" = "success" ]; then
            echo "G24=${{ steps.fallback.outputs.gold24 }}" >> "$GITHUB_OUTPUT"
            echo "SIL=${{ steps.fallback.outputs.silver }}" >> "$GITHUB_OUTPUT"
            echo "SRC=${{ steps.fallback.outputs.source }}" >> "$GITHUB_OUTPUT"
          else
            echo "No provider succeeded; keeping previous rates."
            exit 2
          fi

      - name: Validate numbers (basic sanity window)
        run: |
          set -euo pipefail
          G24='${{ steps.out.outputs.G24 }}'
          SIL='${{ steps.out.outputs.SIL }}'
          if [ -z "$G24" ] || [ -z "$SIL" ]; then echo "Missing outputs"; exit 1; fi
          if [ "$G24" -lt 100 ] || [ "$G24" -gt 20000 ]; then echo "Gold24 out of range: $G24"; exit 1; fi
          if [ "$SIL" -lt 1 ] || [ "$SIL" -gt 2000 ]; then echo "Silver out of range: $SIL"; exit 1; fi

      - name: Write rates.json
        run: |
          set -euo pipefail
          mkdir -p data
          GOLD24='${{ steps.out.outputs.G24 }}'
          SILVER='${{ steps.out.outputs.SIL }}'
          SRC='${{ steps.out.outputs.SRC }}'
          GOLD22=$(python3 -c "print(int(round(${GOLD24} * 0.9167)))")
          UPDATED=$(TZ=Asia/Kolkata date "+%Y-%m-%d %H:%M IST")
          cat > data/rates.json <<JSON
          {
            "gold24k": ${GOLD24},
            "gold22k": ${GOLD22},
            "silver": ${SILVER},
            "updated": "${UPDATED}",
            "source": "${SRC} (spot per gram, INR)"
          }
          JSON

      - name: Commit & push
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/rates.json
          git commit -m "Auto-update rates (rotating providers + inversion fix)" || echo "No changes"
          git push
