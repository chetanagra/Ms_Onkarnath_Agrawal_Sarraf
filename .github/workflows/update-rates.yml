name: Update gold/silver (GoldAPI only, 2x/weekday, MCX parity)

on:
  schedule:
    - cron: "30 3 * * 1-5"     # 09:00 IST Mon–Fri
    - cron: "30 12 * * 1-5"    # 18:00 IST Mon–Fri
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      TZ: "Asia/Kolkata"
      OUNCE_TO_GRAM: "31.1034768"
      PURITY_NUM: "995"
      PURITY_DEN: "999"
      DUTY: "0.065"       # 5% BCD + 1% AIDC + 0.5% SWS
      BANK: "0.001"       # 0.1% banking/logistics

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq + python3
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3

      - name: Fetch via GoldAPI (XAU & XAG in INR)
        id: goldapi
        env:
          GOLDAPI_KEY: ${{ secrets.GOLDAPI_KEY }}
        run: |
          set -euo pipefail
          [ -z "${GOLDAPI_KEY:-}" ] && { echo "No GOLDAPI_KEY"; exit 1; }

          XAU_JSON=$(curl -fSs -H "x-access-token: $GOLDAPI_KEY" https://www.goldapi.io/api/XAU/INR)
          XAG_JSON=$(curl -fSs -H "x-access-token: $GOLDAPI_KEY" https://www.goldapi.io/api/XAG/INR)

          # Prefer INR/gram; else derive from INR/oz
          G_INR_G=$(echo "$XAU_JSON" | jq -r '.price_gram_24k // empty')
          if [ -z "$G_INR_G" ] || [ "$G_INR_G" = "null" ]; then
            POZ_G=$(echo "$XAU_JSON" | jq -r '.price // empty')  # ₹/oz
            [ -z "$POZ_G" ] && { echo "GoldAPI missing gold price"; exit 1; }
            export POZ_G OUNCE_TO_GRAM
            G_INR_G=$(python3 - <<'PY'
import os
print(float(os.environ['POZ_G'])/float(os.environ['OUNCE_TO_GRAM']))
PY
)
          fi

          S_INR_G=$(echo "$XAG_JSON" | jq -r '.price_gram_999 // empty')
          if [ -z "$S_INR_G" ] || [ "$S_INR_G" = "null" ]; then
            POZ_S=$(echo "$XAG_JSON" | jq -r '.price // empty') || true
            if [ -n "${POZ_S:-}" ]; then
              export POZ_S OUNCE_TO_GRAM
              S_INR_G=$(python3 - <<'PY'
import os
print(float(os.environ['POZ_S'])/float(os.environ['OUNCE_TO_GRAM']))
PY
)
            else
              S_INR_G=""
            fi
          fi

          TS=$(echo "$XAU_JSON" | jq -r '.timestamp // empty')

          echo "gold24k_inr_per_g=$G_INR_G" >> "$GITHUB_OUTPUT"
          echo "silver_inr_per_g_999=${S_INR_G:-}" >> "$GITHUB_OUTPUT"
          echo "timestamp=$TS" >> "$GITHUB_OUTPUT"

      - name: Compute MCX-style parity (995 + duty + bank)
        id: parity
        run: |
          set -euo pipefail
          G_INR_G='${{ steps.goldapi.outputs.gold24k_inr_per_g }}'
          [ -z "$G_INR_G" ] && { echo "Missing gold INR/gram"; exit 1; }
          export G_INR_G PURITY_NUM PURITY_DEN DUTY BANK

          python3 - <<'PY'
import os, json
g = float(os.environ['G_INR_G'])           # INR per gram (24k)
purity = float(os.environ['PURITY_NUM'])/float(os.environ['PURITY_DEN'])  # 995/999
duty   = float(os.environ['DUTY'])   # 0.065
bank   = float(os.environ['BANK'])   # 0.001

base_995 = g * purity
landed_per_gram = base_995 * (1 + duty + bank)
landed_per_10g  = landed_per_gram * 10
landed_per_kg   = landed_per_gram * 1000

out = {
  "gold24k_inr_per_g": round(g, 4),
  "base_995_inr_per_g": round(base_995, 4),
  "landed_per_gram": round(landed_per_gram, 2),
  "landed_per_10g": round(landed_per_10g, 2),
  "landed_per_kg": round(landed_per_kg, 2)
}
print(json.dumps(out))
PY

      - name: Write rates.json
        run: |
          set -euo pipefail
          mkdir -p data
          G_INR_G='${{ steps.goldapi.outputs.gold24k_inr_per_g }}'
          S_INR_G='${{ steps.goldapi.outputs.silver_inr_per_g_999 }}'
          TS='${{ steps.goldapi.outputs.timestamp }}'

          PURITY_NUM=${PURITY_NUM}; PURITY_DEN=${PURITY_DEN}; DUTY=${DUTY}; BANK=${BANK}
          BASE_995=$(python3 - <<PY
g=${G_INR_G}; purity=${PURITY_NUM}/${PURITY_DEN}
print(round(g*purity,4))
PY
)
          LANDED_G=$(python3 - <<PY
g=${G_INR_G}; purity=${PURITY_NUM}/${PURITY_DEN}; duty=${DUTY}; bank=${BANK}
print(round((g*purity)*(1+duty+bank),2))
PY
)
          LANDED_10G=$(python3 - <<PY
x=${LANDED_G}
print(round(x*10,2))
PY
)
          LANDED_KG=$(python3 - <<PY
x=${LANDED_G}
print(round(x*1000,2))
PY
)
          UPDATED=$(TZ=Asia/Kolkata date "+%Y-%m-%d %H:%M IST")

          cat > data/rates.json <<JSON
          {
            "gold24k_inr_per_g": ${G_INR_G},
            "silver_inr_per_g_999": ${S_INR_G:-0},
            "parity": {
              "purity_used": "${PURITY_NUM}/${PURITY_DEN}",
              "duty": ${DUTY},
              "bank": ${BANK},
              "landed_per_gram": ${LANDED_G},
              "landed_per_10g": ${LANDED_10G},
              "landed_per_kg": ${LANDED_KG}
            },
            "updated": "${UPDATED}",
            "goldapi_timestamp": ${TS},
            "source": "GoldAPI (XAU & XAG)"
          }
          JSON

      - name: Commit & push
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/rates.json
          git commit -m "GoldAPI XAU+XAG, 2 runs/weekday, MCX parity (995, duty 6.5%, bank 0.1%)" || echo "No changes"
          git push
